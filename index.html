<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Browser Game</title>

    <script type="text/javascript" src="js/Entities.js"></script>
</head>

<body>
    <canvas id="ctx" width="500" height="500" style="border:1px solid black;"></canvas>

    <script>

        const HEIGHT = 500;
        const WIDTH = 500;
        const HEALTH = 10;

        var timeWhenGameStarted = Date.now();

        var ctx = document.getElementById("ctx").getContext('2d');

        ctx.font = '30px Arial';

        var frameCount = 0;
        var score = 0;

        // Loading the image (im Memory)
        
        var Img = {};

        Img.player = new Image();
        Img.player.src = "images/player.png";
        Img.enemy = new Image();
        Img.enemy.src = "images/enemy.png";
        Img.bullet = new Image();
        Img.bullet.src = "images/bullet.png";
        Img.upgrade1 = new Image();
        Img.upgrade1.src = "images/upgrade1.png";
        Img.upgrade2 = new Image();
        Img.upgrade2.src = "images/upgrade2.png";
        Img.map = new Image();
        Img.map.src = "images/map.png";
        //

        TestCollisionRectRect = function (rect1, rect2) {
            return rect1.x <= rect2.x + rect2.width
                && rect2.x <= rect1.x + rect1.width
                && rect1.y <= rect2.y + rect2.height
                && rect2.y <= rect1.y + rect1.height;
        }

        document.onclick = function (mouse) {
            player.PerformAttack();
        }

        document.oncontextmenu = function (mouse) {
            player.PerformSpecialAttack();
            mouse.preventDefault();
        }

        document.onmousemove = function (mouse) {
            var mouseX = mouse.clientX - document.getElementById('ctx').getBoundingClientRect().left;
            var mouseY = mouse.clientY - document.getElementById('ctx').getBoundingClientRect().top;

            mouseX -= player.x;
            mouseY -= player.y;

            player.aimAngle = Math.atan2(mouseY, mouseX) / Math.PI * 180;

        }

        document.onkeydown = function (event) {
            if (event.keyCode === 68) {//d
                player.pressingRight = true;
            }
            else if (event.keyCode === 83) {//s
                player.pressingDown = true;
            }
            else if (event.keyCode === 65) {//a
                player.pressingLeft = true;
            }
            else if (event.keyCode === 87) {//w
                player.pressingUp = true;
            }
        }

        document.onkeyup = function (event) {
            if (event.keyCode === 68) {//d
                player.pressingRight = false;
            }
            else if (event.keyCode === 83) {//s
                player.pressingDown = false;
            }
            else if (event.keyCode === 65) {//a
                player.pressingLeft = false;
            }
            else if (event.keyCode === 87) {//w
                player.pressingUp = false;
            }
        }

        Update = function () {
            ctx.clearRect(0, 0, WIDTH, HEIGHT);
            frameCount++;
            score++;

            if (frameCount % 100 === 0) {
                RandomlyGenerateEnemy();
            }

            if (frameCount % 75 === 0) {
                RandomlyGenerateUpgrade();

            }

            for (var key in bulletList) {
                bulletList[key].Update();
            }

            for (var key in upgradeList) {
                upgradeList[key].Update();
            }

            for (var key in enemyList) {
                enemyList[key].Update();
            }
            player.Update();
            ctx.fillText(player.hp + " Hp", 0, 30);
            ctx.fillText("Score :" + score, 200, 30);
        }

        StartNewGame = function () {
            timeWhenGameStarted = Date.now();
            player.hp = HEALTH;
            frameCount = 0;
            score = 0;
            enemyList = {};
            upgradeList = {};
            bulletList = {};
            RandomlyGenerateEnemy();
            RandomlyGenerateEnemy();
            RandomlyGenerateEnemy();
        }

        player = Player();
        StartNewGame();
        setInterval(Update, 40);

    </script>
</body>

</html>