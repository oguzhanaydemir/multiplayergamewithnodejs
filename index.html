<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Browser Game</title>
</head>
<body>
    <canvas id="ctx" width="500" height="500" style="border:1px solid black;"></canvas>

<script>

        const HEIGHT = 500;
        const WIDTH = 500;
        const HEALTH = 10;
        const MILISECOND = 1000;
        
        var playerWidth = 20;
        var playerHeight = 20;
        
        var timeWhenGameStarted = Date.now();
        
        var ctx = document.getElementById("ctx").getContext('2d');
        
        ctx.font='30px Arial';


       //player
       var player = {
            x : 50,
            spdX : 30,
            y : 40,
            spdY : 5,
            hp:HEALTH,
            width : playerWidth,
            height : playerHeight,
            color: "green",
            attackSpeed:10,
            attackCounter:0,
            pressingDown : false,
            pressingUp : false,
            pressingLeft : false,
            pressingRight : false
       }
       //enemy
        var enemyList ={};
        var upgradeList ={};
        var bulletList ={};

        var frameCount = 0;
        var score = 0;

       //get distance between player and enemy

       GetDistanceBetweenEntity = function (entity1, entity2){
           var vx = entity1.x - entity2.x;
           var vy = entity1.y - entity2.y;

           return Math.sqrt(vx*vx + vy*vy);
       }

       TestCollisionEntity = function (entity1, entity2){
            var rect1 = {
                x:entity1.x-entity1.width/2,
                y:entity1.y-entity1.height/2,
                width:entity1.width,
                height:entity1.height
            }

            var rect2 = {
                x:entity2.x-entity2.width/2,
                y:entity2.y-entity2.height/2,
                width:entity2.width,
                height:entity2.height
            }

            return TestCollisionRectRect(rect1, rect2);
       }

       

       //Create Enemy
       CreateEnemy = function (id, x, y, spdX, spdY, width, height){
            var enemy = {
                id:id,
                x : x,
                y : y,
                spdX : spdX,
                spdY : spdY,
                width : width,
                height : height,
                color:"red"
            }
        enemyList[id] = enemy;
       }

       //Create Upgrade

       CreateUpgrade = function (id, x, y, spdX, spdY, width, height, color, category){
            var upgrade = {
                id:id,
                x : x,
                y : y,
                spdX : spdX,
                spdY : spdY,
                width : width,
                height : height,
                color: color,
                category:category
            }
            
            upgradeList[id] = upgrade;
       }

       CreateBullet = function (id, x, y, spdX, spdY, width, height){
            var bullet = {
                id:id,
                x : x,
                y : y,
                spdX : spdX,
                spdY : spdY,
                width : width,
                height : height,
                color:"black",
                timer:0
            }
            
            bulletList[id] = bullet;
       }
       
       document.onclick = function(mouse){
        if(player.attackCounter > 25){
            RandomlyGenerateBullet();
            player.attackCounter = 0;
        }
    }

       document.onmousemove = function(mouse){
           /*var mouseX = mouse.clientX - document.getElementById('ctx').getBoundingClientRect().left;
           var mouseY = mouse.clientY - document.getElementById('ctx').getBoundingClientRect().top;

            if(mouseX < player.width/2){
                mouseX=player.width/2;
            }
            if(mouseX>WIDTH - player.width/2){
                mouseX = WIDTH - player.width/2;
            }
            if(mouseY < player.height/2){
                mouseY = player.height/2;
            }
            if(mouseY>HEIGHT-player.height/2){
                mouseY = HEIGHT - player.height/2;
            }

           player.x = mouseX;
           player.y = mouseY;*/
    }

       document.onkeydown = function(event){
           if(event.keyCode === 68){//d
                player.pressingRight = true;
           }
           else if(event.keyCode === 83){//s
                player.pressingDown = true;
           }
           else if(event.keyCode === 65){//a
               player.pressingLeft = true;
           }
           else if(event.keyCode === 87){//w
               player.pressingUp = true;
           }
    }

       document.onkeyup = function(event){
            if(event.keyCode === 68){//d
                player.pressingRight = false;
           }
           else if(event.keyCode === 83){//s
                player.pressingDown = false;
           }
           else if(event.keyCode === 65){//a
               player.pressingLeft = false;
           }
           else if(event.keyCode === 87){//w
               player.pressingUp = false;
           }
    }

       UpdatePlayerPosition = function(){
           if(player.pressingRight){
                player.x += 10;
           }
           if(player.pressingDown){
                player.y += 10;
           }
           if(player.pressingLeft){
                player.x -= 10;
           }
           if(player.pressingUp){
                player.y -= 10;
           }

            //isPositionValid

            if(player.x < player.width/2){
                player.x=player.width/2;
            }
            if(player.x > WIDTH - player.width/2){
                player.x = WIDTH - player.width/2;
            }
            if(player.y < player.height/2){
                player.y  = player.height/2;
            }
            if(player.y > HEIGHT-player.height/2){
                player.y = HEIGHT - player.height/2;
            }
        }

         UpdateEntity = function (entity){
         UpdateEntityPosition(entity);
         DrawEntity(entity);
    }

   
    TestCollisionRectRect = function(rect1, rect2){
           return    rect1.x <= rect2.x + rect2.width
                  && rect2.x <= rect1.x + rect1.width
                  && rect1.y <= rect2.y + rect2.height
                  && rect2.y <= rect1.y + rect1.height; 
       }



    DrawEntity = function(entity){
        ctx.save();
        ctx.fillStyle = entity.color;
        ctx.fillRect(entity.x-entity.width/2, entity.y-entity.height/2, entity.width, entity.height);
        ctx.restore();
    }

   

    UpdateEntityPosition = function(entity){
        entity.x+= entity.spdX;
        entity.y+= entity.spdY;

        if( entity.x > WIDTH  || entity.x < 0){
            entity.spdX = -entity.spdX;
        }
        if( entity.y > HEIGHT  || entity.y< 0){
           entity. spdY = -entity.spdY;
        }
    }
    

     //Random Enenmy
    RandomlyGenerateEnemy = function(){

            var id = Math.random();
            var x = Math.random() * WIDTH/2;
            var y = Math.random() * HEIGHT/2;
            var spdX = 5 + Math.random()*5;
            var spdY = 5 + Math.random()*5;
            var width = 10 + Math.random()*30;
            var height = 10 + Math.random()*30;

            CreateEnemy(id, x, y, spdX, spdY, width, height);
    }

    //Random Upgrade

    RandomlyGenerateUpgrade = function(){

        var id = Math.random();
        var x = Math.random() * WIDTH/2;
        var y = Math.random() * HEIGHT/2;
        var spdX = 0;
        var spdY = 0;
        var width = 10;
        var height = 10;

        if(Math.random()<0.5){
            var category = 'low';
            var color = 'orange';
        }else{
            var category = 'high';
            var color = 'purple';
        }

        CreateUpgrade(id, x, y, spdX, spdY, width, height, color, category);
    }

    RandomlyGenerateBullet = function(){
        var angle = Math.random()*360;
        var id = Math.random();
        var x = player.x;
        var y = player.y;
        var spdX = Math.cos(angle/180*Math.PI)*5;
        var spdY =Math.sin(angle/180*Math.PI)*5;
        var width = 10;
        var height = 10;

        CreateBullet(id, x, y, spdX, spdY, width, height);
    }
   
   
    Update = function (){
        ctx.clearRect(0, 0, WIDTH, HEIGHT);
        frameCount++;
        score++;

        if(frameCount % 100 === 0){
            RandomlyGenerateEnemy();
        }

        if(frameCount % 75 === 0){
            RandomlyGenerateUpgrade();
        
        }

        player.attackCounter+= player.attackSpeed;

        

        for(var key in bulletList){
            var toRemove = false;
            UpdateEntity(bulletList[key]);

            bulletList[key].timer++;

            if(bulletList[key].timer>75){
                toRemove=true;
            }

            for(var enemyKey in enemyList){
                var isColliding = TestCollisionEntity(bulletList[key], enemyList[enemyKey]);
                if(isColliding){
                    toRemove=true;
                    delete enemyList[enemyKey];
                    break;
                }
            }

            if(toRemove){
                delete bulletList[key];
            }
        }

        for(var key in upgradeList){
            UpdateEntity(upgradeList[key]);
            var isColliding = TestCollisionEntity(player, upgradeList[key]);

            if(isColliding){

                if(upgradeList[key].category === 'high'){
                    score += 10000;
                }else{
                    score += 1000;
                }
                delete upgradeList[key];
            }
        }

        for(var key in enemyList){
           UpdateEntity(enemyList[key]);

           var isColliding = TestCollisionEntity(player, enemyList[key]);

           if(isColliding){
                player.hp -= 1;
                if(player.hp<=0){
                    var timeSurvived = Date.now() - timeWhenGameStarted; 
                    console.log('GAME OVER.\nSCORE :' + timeSurvived + " ms.");
                    StartNewGame();
                }
           }
       }
       UpdatePlayerPosition();
       DrawEntity(player);
        ctx.fillText(player.hp + " Hp", 0, 30);
        ctx.fillText("Score :" + score, 200, 30);
    }
    StartNewGame = function(){
        timeWhenGameStarted = Date.now();
        player.hp = HEALTH;
        frameCount = 0;
        enemyList={};
        upgradeList={};
        bulletList={};
        RandomlyGenerateEnemy();
        RandomlyGenerateEnemy();
        RandomlyGenerateEnemy();
    }

   
       
       StartNewGame();
       setInterval(Update, 40);

</script>
</body>
</html>