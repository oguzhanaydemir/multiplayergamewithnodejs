<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Browser Game</title>
</head>

<body>
    <canvas id="ctx" width="500" height="500" style="border:1px solid black;"></canvas>

    <script>

        const HEIGHT = 500;
        const WIDTH = 500;
        const HEALTH = 10;

        var playerWidth = 20;
        var playerHeight = 20;
        var playerSpeed = 10;
        var timeWhenGameStarted = Date.now();

        var ctx = document.getElementById("ctx").getContext('2d');

        ctx.font = '30px Arial';

        var frameCount = 0;
        var score = 0;

        //player
        var player;

        Entity = function (type, id, x, y, spdX, spdY, width, height, color) {
            var self = {
                type: type,
                id: id,
                x: x,
                y: y,
                spdX: spdX,
                spdY: spdY,
                width: width,
                height: height,
                color: color
            };

            self.Update = function () {
                self.UpdatePosition();
                self.Draw();
            }

            self.Draw = function () {
                ctx.save();
                ctx.fillStyle = self.color;
                ctx.fillRect(self.x - self.width / 2, self.y - self.height / 2, self.width, self.height);
                ctx.restore();
            }

            self.GetDistance = function (entity2) {
                var vx = self.x - entity2.x;
                var vy = self.y - entity2.y;

                return Math.sqrt(vx * vx + vy * vy);
            }

            self.TestCollision = function(entity2){ 
                var rect1 = {
                        x:self.x-self.width/2,
                        y:self.y-self.height/2,
                        width:self.width,
                        height:self.height
                }
                var rect2 = {
                        x:entity2.x-entity2.width/2,
                        y:entity2.y-entity2.height/2,
                        width:entity2.width,
                        height:entity2.height
                }
                return TestCollisionRectRect(rect1,rect2);
               
        }


            self.UpdatePosition = function () {
                self.x += self.spdX;
                self.y += self.spdY;

                if (self.x > WIDTH || self.x < 0) {
                    self.spdX = -self.spdX;
                }
                if (self.y > HEIGHT || self.y < 0) {
                    self.spdY = -self.spdY;
                }
            }

            return self;
        }
        Player = function () {
            var self = Actor('player', 'player.id', 50, 30, 40, 5, playerWidth, playerHeight, 'green', HEALTH, 1);
            //
            self.pressingDown = false;
            self.pressingUp = false;
            self.pressingLeft = false;
            self.pressingRight = false;

            self.UpdatePosition = function () {
                if (self.pressingRight) {
                    self.x += playerSpeed;
                }
                if (self.pressingDown) {
                    self.y += playerSpeed;
                }
                if (self.pressingLeft) {
                    self.x -= playerSpeed;
                }
                if (self.pressingUp) {
                    self.y -= playerSpeed;
                }

                //isPositionValid

                if (self.x < self.width / 2) {
                    self.x = self.width / 2;
                }
                if (self.x > WIDTH - self.width / 2) {
                    self.x = WIDTH - self.width / 2;
                }
                if (self.y < self.height / 2) {
                    self.y = self.height / 2;
                }
                if (self.y > HEIGHT - self.height / 2) {
                    self.y = HEIGHT - self.height / 2;
                }
            }

            var super_update = self.Update;

            self.Update = function(){
                super_update();
                if (self.hp <= 0) {
                var timeSurvived = Date.now() - timeWhenGameStarted;
                console.log('Your score is ' + timeSurvived);
                StartNewGame();
            }
            }

            return self;

        }
        Actor = function (type, id, x, y, spdX, spdY, width, height, color, hp, attackSpeed) {
            var self = Entity(type, id, x, y, spdX, spdY, width, height, color);

            self.hp = hp;
            self.attackSpeed = attackSpeed;
            self.attackCounter = 0;
            self.aimAngle = 0;

            var super_update = self.Update;

            self.Update = function () {
                super_update();
                self.attackCounter += self.attackSpeed;
            }

            self.PerformAttack = function () {
                if (self.attackCounter > 25) {	//every 1 sec
                    self.attackCounter = 0;
                    GenerateBullet(self);
                }
            }
            self.PerformSpecialAttack = function () {

                if (self.attackCounter > 50) {
                    self.attackCounter = 0;
                    /* for(var angle = 0; angle < 360; angle++){
                        GenerateBullet(player, angle);
                    }*/
                    GenerateBullet(self, self.aimAngle - 5);
                    GenerateBullet(self, self.aimAngle);
                    GenerateBullet(self, self.aimAngle + 5);
                }

            }


            return self;
        }
        var enemyList = {};
        var upgradeList = {};
        var bulletList = {};

        // Enemy
        Enemy = function (id, x, y, spdX, spdY, width, height) {
            var self = Actor('enemy', id, x, y, spdX, spdY, width, height, 'red', 10, 1);
            
            var super_update = self.Update;
            
            self.Update = function(){
                super_update();
                self.PerformAttack();

                var isColliding = player.TestCollision(self);

                if (isColliding) {
                    player.hp -= 1;

                }
            }

            enemyList[id] = self;
        }

        //Randomly Enenmy
        RandomlyGenerateEnemy = function () {

            var id = Math.random();
            var x = Math.random() * WIDTH / 2;
            var y = Math.random() * HEIGHT / 2;
            var spdX = 5 + Math.random() * 5;
            var spdY = 5 + Math.random() * 5;
            var width = 10 + Math.random() * 30;
            var height = 10 + Math.random() * 30;

            Enemy(id, x, y, spdX, spdY, width, height);
        }

       
        Upgrade = function (id, x, y, spdX, spdY, width, height, color, category) {
            var self = Entity('upgrade', id, x, y, spdX, spdY, width, height, color);
            console.log(self.id);
            var super_update = self.Update;
            self.Update = function () {
                super_update();

                var isColliding = player.TestCollision(self);

                if (isColliding) {

                    if (self.category === 'score') {
                        score += 1000;
                    }
                    if (self.category === 'attack-speed') {
                        player.attackSpeed += 3;
                    }
                    console.log(self.id);
                    delete upgradeList[self.id];
                }
              
            }

            self.category = category;
            upgradeList[id] = self;
        }

        //Randomly Upgrade
        RandomlyGenerateUpgrade = function () {

            var x = Math.random() * WIDTH;
            var y = Math.random() * HEIGHT;
            var width = 10;
            var height = 10;
            var id = Math.random();
            var spdX = 0;
            var spdY = 0;

            if (Math.random() < 0.5) {
                var category = 'score';
                var color = 'orange';
            } else {
                var category = 'attack-speed';
                var color = 'purple';
            }

            Upgrade(id, x, y, spdX, spdY, width, height, color, category);
        }

        // Bullet
        Bullet = function (id, x, y, spdX, spdY, width, height) {
            var self = Actor('bullet', id, x, y, spdX, spdY, width, height, 'black', 0, 0);

            self.timer = 0;

            var super_update = self.Update;
            self.Update = function () {
                super_update();
                var toRemove = false;
                self.timer++;

                if (self.timer > 75) {
                    toRemove = true;
                }

                for (var enemyKey in enemyList) {
                    /*  var isColliding = self.TestCollision(enemyList[enemyKey]);
                      if (isColliding) {
                          toRemove = true;
                          delete enemyList[enemyKey];
                          break;
                      }*/
                }

                if (toRemove) {
                    delete bulletList[self.id];
                }
            }

            bulletList[id] = self;
        }

        //Randomly Bullet
        GenerateBullet = function (actor, overwriteAngle) {
            var x = actor.x;
            var y = actor.y;
            var height = 10;
            var width = 10;
            var id = Math.random();

            var angle;
            if (overwriteAngle !== undefined) {
                angle = overwriteAngle;
            } else {

                angle = actor.aimAngle;
            }

            var spdX = Math.cos(angle / 180 * Math.PI) * 5;
            var spdY = Math.sin(angle / 180 * Math.PI) * 5;

            Bullet(id, x, y, spdX, spdY, width, height);
        }

        TestCollisionRectRect = function (rect1, rect2) {
            return rect1.x <= rect2.x + rect2.width
                && rect2.x <= rect1.x + rect1.width
                && rect1.y <= rect2.y + rect2.height
                && rect2.y <= rect1.y + rect1.height;
        }

        document.onclick = function (mouse) {
            player.PerformAttack();
        }

        document.oncontextmenu = function (mouse) {
            player.PerformSpecialAttack();
            mouse.preventDefault();
        }

        document.onmousemove = function (mouse) {
            var mouseX = mouse.clientX - document.getElementById('ctx').getBoundingClientRect().left;
            var mouseY = mouse.clientY - document.getElementById('ctx').getBoundingClientRect().top;

            mouseX -= player.x;
            mouseY -= player.y;

            player.aimAngle = Math.atan2(mouseY, mouseX) / Math.PI * 180;

        }

        document.onkeydown = function (event) {
            if (event.keyCode === 68) {//d
                player.pressingRight = true;
            }
            else if (event.keyCode === 83) {//s
                player.pressingDown = true;
            }
            else if (event.keyCode === 65) {//a
                player.pressingLeft = true;
            }
            else if (event.keyCode === 87) {//w
                player.pressingUp = true;
            }
        }

        document.onkeyup = function (event) {
            if (event.keyCode === 68) {//d
                player.pressingRight = false;
            }
            else if (event.keyCode === 83) {//s
                player.pressingDown = false;
            }
            else if (event.keyCode === 65) {//a
                player.pressingLeft = false;
            }
            else if (event.keyCode === 87) {//w
                player.pressingUp = false;
            }
        }

        Update = function () {
            ctx.clearRect(0, 0, WIDTH, HEIGHT);
            frameCount++;
            score++;

            if (frameCount % 100 === 0) {
                RandomlyGenerateEnemy();
            }

            if (frameCount % 75 === 0) {
                RandomlyGenerateUpgrade();

            }

            for (var key in bulletList) {
                bulletList[key].Update();
            }

            for (var key in upgradeList) {
                upgradeList[key].Update();
            }

            for (var key in enemyList) {
                enemyList[key].Update();
            }
            player.Update();
            ctx.fillText(player.hp + " Hp", 0, 30);
            ctx.fillText("Score :" + score, 200, 30);
        }

        StartNewGame = function () {
            timeWhenGameStarted = Date.now();
            player.hp = HEALTH;
            frameCount = 0;
            score = 0;
            enemyList = {};
            upgradeList = {};
            bulletList = {};
            RandomlyGenerateEnemy();
            RandomlyGenerateEnemy();
            RandomlyGenerateEnemy();
        }

        player = Player();
        StartNewGame();
        setInterval(Update, 40);

    </script>
</body>

</html>